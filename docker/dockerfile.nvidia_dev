# syntax=docker/dockerfile:1.6
ARG TARGETPLATFORM
ARG UBUNTU_MAJOR=22
ARG UBUNTU_MINOR=04
ARG CUDA_VERSION=12.6.3
ARG ROS_DISTRO=humble

FROM nvidia/cuda:${CUDA_VERSION}-devel-ubuntu${UBUNTU_MAJOR}.${UBUNTU_MINOR}

SHELL ["/bin/bash", "-o", "pipefail", "-c"]
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# ---- Base OS deps (keep this early for caching) ----
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg2 lsb-release locales \
    build-essential cmake git wget udev usbutils zstd jq \
    python3 python3-pip python3-dev python3-venv \
  && locale-gen en_US.UTF-8 \
  && update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 \
  && rm -rf /var/lib/apt/lists/*

# ---- ROS 2 apt repo + install ROS + tools (official method) ----
# (This is per ROS docs for Humble on Ubuntu)  :contentReference[oaicite:4]{index=4}
RUN apt-get update && apt-get install -y --no-install-recommends software-properties-common \
  && add-apt-repository universe \
  && rm -rf /var/lib/apt/lists/*

RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
    | gpg --dearmor -o /usr/share/keyrings/ros-archive-keyring.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" \
    > /etc/apt/sources.list.d/ros2.list

# ---- ROS packages you need (install in one shot) ----
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-${ROS_DISTRO}-ros-base \
    ros-dev-tools \
    python3-colcon-common-extensions \
    ros-${ROS_DISTRO}-mavros \
    ros-${ROS_DISTRO}-rmw-zenoh-cpp \
    ros-${ROS_DISTRO}-tf-transformations \
    iputils-ping iproute2 \
  && rm -rf /var/lib/apt/lists/*

# ---- GeographicLib datasets for MAVROS ----
RUN wget -q https://raw.githubusercontent.com/mavlink/mavros/ros2/mavros/scripts/install_geographiclib_datasets.sh \
  && chmod +x install_geographiclib_datasets.sh \
  && ./install_geographiclib_datasets.sh \
  && rm install_geographiclib_datasets.sh

# ---- rosdep init/update (make it idempotent) ----
RUN if [ ! -e /etc/ros/rosdep/sources.list.d/20-default.list ]; then rosdep init; fi \
  && rosdep update

# ---- (Optional) Install ZED SDK manually ----
# If you instead start FROM stereolabs/zed:* you can remove this entire block.
ARG ZED_SDK_URL=""
RUN if [ -n "${ZED_SDK_URL}" ]; then \
      wget -q -O /tmp/ZED_SDK.run "${ZED_SDK_URL}" && \
      chmod +x /tmp/ZED_SDK.run && \
      /tmp/ZED_SDK.run --silent skip_tools skip_cuda && \
      rm /tmp/ZED_SDK.run && \
      ln -sf /lib/x86_64-linux-gnu/libusb-1.0.so.0 /usr/lib/x86_64-linux-gnu/libusb-1.0.so ; \
    fi

# ---- Your app workspace area ----
WORKDIR /app

# Copy only what you need for rosdep first (cache-friendly)
COPY packages/ros2_gremsy /app/packages/ros2_gremsy

RUN source /opt/ros/${ROS_DISTRO}/setup.bash && \
    rosdep install -y -r -q --from-paths /app/packages/ros2_gremsy --ignore-src --rosdistro ${ROS_DISTRO}

# ---- Non-root user at the end ----
ARG UID=1000
ARG GID=1000
RUN groupadd -g ${GID} dev \
  && useradd -m -u ${UID} -g ${GID} dev \
  && chown -R dev:dev /app
USER dev
WORKDIR /app
CMD ["bash"]
